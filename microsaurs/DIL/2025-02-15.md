# Chap 12. 프로세스 동기화

## 동기화란

### 1. 동기화의 의미

동시다발적으로 실행되는 많은 프로세스는 서로 데이터를 주고받으며 실행  
ex. 워드 프로세서 → 사용자로부터 입력을 받는 프로세스, 입력한 내용의 맞춤법을 검사하는 프로세스, 입력한 내용을 화면에 출력해주는 프로세스 등..  
각기 다른 독립적인 프로세스이지만 공동의 목표를 위해 서로 협력하는 존재  
➡️ 서로 협력적으로 실행되는 프로세스들은 아무렇게나 마구 동시에 실행 X

### 프로세스 동기화

프로세스들 사이의 수행 시기를 맞추는 것을 의미  
특정 자원에 접근할 때 한 개의 프로세스만 접근하게 하거나, 프로세스를 올바른 순서대로 실행하게 하는 것을 의미

> - 실행 순서 제어 : 프로세스를 올바른 순서대로 실행하기
> - 상호 배제 : 동시에 접근해서는 안되는 자원에 하나의 프로세스만 접근하게 하기

\* 실행의 흐름을 갖는 모든 것은 동기화의 대상 ! (프로세스, 스레드 ..)

- **실행 순서 제어를 위한 동기화**  
   동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것

- **상호 배제를 위한 동기화**  
   공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘

### 2. 생산자와 소비자 문제

> - 생산자 : 물건을 계속해서 생산하는 프로세스
> - 소비자 : 물건을 계속해서 소비하는 프로세스

➡️ '총합' 이라는 공유 자원을 동시에 접근하면서 문제 발생

### 3. 공유 자원과 임계 구역

> - **공유 자원** : 동시에 실행되는 프로세스들이 가지는 공동의 자원  
>    전역변소, 파일, 입출력장치, 보조기억장치 등이 될 수 있음
> - **임계 구역** : 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역  
>   두 개 이상의 프로세스가 동시에 실행되면 안 되는 영역
> - **레이스 컨디션** : 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우

➡️ 상호 배제를 위한 동기화는 이와 같은 일이 발생하지 않도록 두개 이상의 프로세스가 임계 구역에 동시에 접근하지 못하도록 관리하는 것

> - 상호 배제 : 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
> - 진행 : 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
> - 유한 대기 : 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다. (임계 구역에 들어오기 위해 무한정 대기 X)

## 동기화 기법

### 1. 뮤텍스 락

동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 상호 배제를 위한 동기화 도구  
→ 임계 구역에 진입하는 프로세스는 '내가 지금 임계 구역에 있음'을 알리기 위해 **뮤텍스 락을 이용**  
다른 프로세스는 임계 구역이 잠겨 있다면 기다리고, 잠겨있지 않다면 임계 구역에 진입

- 뮤텍스 락의 단순 형태 = **하나의 전역 변수 + 두개의 함수**
  - 자물쇠 역할 : 프로세스들이 공유하는 `전역 변수 lock`
  - 임계 구역을 잠그는 역할 `acquire 함수`
  - 임계 구역의 잠금을 해제하는 역할 `release 함수`

**[acquire 함수]**  
프로세스가 임계 구역에 진입하기 전에 호출하는 함수  
→ 임계 구역이 잠겨 있으면 열릴 때까지 반복 확인, 열려 있다면 임계 구역을 잠그는 함수

**[release 함수]**  
임계 구역에서의 작업이 끝나고 호출하는 함수  
현재 잠긴 임계 구역을 열어주는 함수

➡️ 이런 방식으로 대기하는 것 `바쁜 대기(busy wait)`

### 2. 세마포

뮤텍스 락보다 조금 더 일반화된 방식의 동기화 도구  
공유 자원이 여러 개 있을 경우 여러 개의 프로세스가 각각 공유 자원에 접근이 가능해야 함  
→ 세마포는 공유 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구

TODO: \* 이진 세마포 / 카운팅 세마포(study more)

프로세스는 임계 구역 앞에서 멈춤 신호를 받으면 잠시 기다리고, 가도 좋다는 신호를 받으면 임계 구역으로 진입

**[세마포가 구현되는 방법]**  
하나의 변수 + 두 개의 함수

- 임계 구역에 진입할 수 있는 프로세스의 개수를 나타내는 `전역 변수 S`
- 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 `wait 함수`
- 임계 구역 앞에서 기다리는 프로세스에 '이제 가도 좋다'고 신호를 주는 `signal 함수`  
  \* 변수와 함수 이름은 전공서마다 다를 수 있음

### 뮤텍스락과 세마포 방식의 한계점

→ 바쁜 대기를 반복하며 확인하는 과정에서 CPU 주기 낭비 발생

💡세마포는 더 좋은 방법을 활용!  
wait 함수는 만일 사용할 수 있는 자원이 없는 경우 해당 프로세스 상태를 대기 상태로 만들고, 그 프로세스의 PCB를 세마포를 위한 **대기 큐에 삽입**  
다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고, 프로세스 상태를 **준비 상태로 변경한 뒤 준비 큐로 이동**

> - **세마포를 활용해 프로세스 실행 순서 조정하기**  
>   세마포의 변수 S를 0으로 두고 먼저 실행할 프로세스 뒤에 signal 함수를 붙이고 다음에 실행할 프로세스 앞에 wait 함수 붙이기

### 3. 모니터

[세마포의 한계점]

- 매번 임계 구역 앞뒤로 일일이 wait와 signal 함수를 명시하여 사용 → 번거로움
- wait와 signal의 순서를 헷갈리거나, 세마포 누락, 함수 중복 사용 등의 실수 발생 가능성

모니터 : 공유 자원을 다루는 인터페이스에 접근하기 위한 큐(모니터에 진입하기 위한)큐를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화 제공

**[조건 변수]**

- 특정 조건을 바탕으로 프로세스를 실행하고 일시 중단하기 위해 사용
- 프로세스나 스레드의 실행 순서를 제어하기 위해 사용하는 특별한 변수

[조건 변수르 ㄹ이용하여 프로세스 실행 준서 제어 동기화 제공]

1. 특정 프로세스가 아직 실행될 조건이 되지 않았을 때에는 wait를 통해 실행 중단
2. 특정 프로세스가 실행될 조건이 충족되었을 때에는 signal을 통해 실행 재개
