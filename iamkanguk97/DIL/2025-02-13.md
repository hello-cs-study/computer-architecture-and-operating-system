## 뮤텍스 락 (Mutex Lock)

탈의실 예제를 들어보자.

옷 가게에서 마음에 드는 옷이 있으면 손님은 탈의실에 들어가서 옷을 입어볼 수 있다. 이 때 탈의실에는 한 명의 인원만 들어갈 수 있다.

손님들은 탈의실이라는 자원을 이용하고 탈의실 안에는 손님 한 명씩만 들어갈 수 있기 때문에 `손님`은 `프로세스`, `탈의실`은 `임계구역(Critical Section)` 이라고 할 수 있다.

만약, 밖에서 탈의실에 사람이 있는지 없는지 알 수 없는 상황이면 탈의실이 이용중임을 어떻게 알까? 일단 탈의실을 열어보고 자물쇠가 걸려있다면 탈의실 안에 사람이 있다고 판단하고 기다린다.

**위의 시나리오에서 자물쇠 기능을 코드로 구현한 것이 뮤텍스 락(Mutex Lock) 이다.**<br/>
뮤텍스 락은 동시에 접근해서는 안 되는 자원에 동시에 접근하지 않도록 만드는 도구, 다시 말해 상호 배제를 위한 동기화 도구이다.

acquire(잠금) 함수와 release(해제) 함수가 있다.

과정을 정리해보면 다음과 같다.

-   Lock을 획득할 수 없다면(임계구역에 진입할 수 없다면) 프로세스는 무작정 기다려!
-   Lock을 획득할 수 있다면(임계구역에 진입할 수 있다면) 임계구역을 잠근 뒤에 임계 구역에서의 작업을 진행해!
-   임계 구역에서 빠져나올 땐 다시 암계 구역의 잠금을 해제하면서 임계 구역을 보호할 수 있음.

acquire 함수는 임계 구역이 잠겨있으면 임계 구역이 잠겨있는지 계속해서 확인한다. 즉, 탈의실 문이 잠겨있는지 쉴 새 없이 반복해서 확인하는 것과 동일하다. (바쁜 대기 - busy wait)

<br/>

## 세마포 (Semaphore)

뮤텍스 락은 하나의 공유 자원에 접근하는 프로세스를 선정한 방식이다. 다시 말해서, 탈의실이 1개 밖에 없음을 가정하고 만든 동기화 기술이다.

하지만, 탈의실이 여러 개 있는 상황처럼 공유 자원이 여러 개 있을 경우 여러 개의 프로세스가 각각 공유 자원에 접근이 가능해야 한다.

**세마포는 철도 신호기에서 유래한 단어이다. 기차는 신호기가 내려가 있을 때는 멈춤 신호로 간주하고 잠시 멈춘다. 반대로 신호기가 올라가 있을 때는 가도 좋다는 신호로 간주하고 다시 움직이기 시작한다.**

### 구현 방법

> -   임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수): S
> -   임계 구역에 들어가도 좋은지, 기다려야 할지를 알려주는 함수: wait
> -   임계 구역 앞에서 기다리는 프로세스에 "이제 가도 좋다" 고 신호를 주는 함수: signal

```
wait() {
    while (S <= 0);   // 임계 구역에 진입할 수 있는 프로세스 개수가 0개 이하라면
    ;   // 사용할 수 있는 자원이 이는지 반복적으로 확인
    S--;   // 임계 구역에 진입할 수 있는 프로세스 개수가 하나 이상이면 S를 1 감소시키고 진입
}

signal() {
    S++;   // 임계 구역에서 작업을 마친 뒤 S를 1 증가시킨다.
}
```

### 문제점

-   사용할 수 있는 자원이 없는 경우, 프로세스는 무작정 무한히 반복하면서 S를 확인해야 함!
-   **계속해서 확인하는 시간에 CPU는 더 생산성 있는 작업을 할 수 있는데, CPU 주기를 낭비한다는 점에서 손해이다.**

해당 문제점을 해결하기 위해서 세마포는 더 좋은 방법을 사용한다.

wait 함수는 만일 사용할 수 있는 자원이 없을 경우 해당 프로세스의 상태를 대기 상태로 만들고, 그 프로세스의 PCB를 세마포를 위한 대기 큐에 집어 넣는다.

**그리고, 다른 프로세스가 임계 구역에서의 작업이 끝나고 signal 함수를 호출하면 signal 함수는 대기 중인 프로세스를 대기 큐에서 제거하고, 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮겨준다.**

```
wait() {
    S--;
    if (S < 0) {
        add this process to waiting queue;   // 해당 프로세스의 PCB를 대기 큐에 넣는다.
        sleep();   // 대기 상태로 설정한다.
    }
}

signal() {
    S++;
    if (S <= 0) {
        remove a process from waiting queue;   // 대기 큐에 있는 프로세스를 제거한다.
        wakeup(process);   // 프로세스를 대기 상태에서 준비상태로 변경시킨다.
    }
}
```

### 세마포를 이용한 프로세스 실행 순서 제어

> **세마포의 변수 S를 0으로 설정하고 먼저 실행할 프로세스 뒤에 signal 함수, 다음에 실행할 프로세스 앞에 wait 함수를 붙인다.**
